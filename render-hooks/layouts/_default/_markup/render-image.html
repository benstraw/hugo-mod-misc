{{- $img := .Page.Resources.GetMatch .Destination -}}
{{- if and (not $img) .Page.File -}}
  {{ $path := path.Join .Page.File.Dir .Destination }}
  {{- $img = resources.Get $path -}}
{{- end -}}
{{- with $img -}}
  {{ $bgColor := site.Params.bgColor | default "#fff" }}
  {{ $class := "" }}
  {{ $width2x := 1388}}
  {{ $width1x := 694}}
  {{ $title := $.Title }}
  {{ $alt := $.PlainText }}
  {{ $srcSet := "" }}
  {{ $src := $img.RelPermalink }}
  {{ $imgFormatOptions := printf "%%dx jpg %s q71" $bgColor }}
  {{ $width2x := cond (gt $img.Width $width2x) $img.Width $width2x }}
  {{ $resized1x := $img.Resize (printf $imgFormatOptions $width1x) }}
  {{ $resized2x := $img.Resize (printf $imgFormatOptions $width2x) }}
  <picture>
    <source srcset="{{ $resized2x.RelPermalink }}" media="(min-width: 640px)" />
    <img  width="{{ $resized1x.Width }}" height="{{ $resized1x.Height }}" src="{{ $resized1x.RelPermalink }}" loading="lazy" alt="{{ $alt }}" title="{{ $title }}" {{ with $class }}class="{{ . }}" {{ end }}/>
  </picture>
{{- else -}}
  <img src="{{ .Destination | safeURL }}" alt="{{ $.Text }}" />
{{- end -}}
